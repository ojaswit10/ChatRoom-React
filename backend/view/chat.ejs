<!DOCTYPE html>
<html lang="en">
<head>
  <%- include("./partials/head") %>
  <title>Homepage</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #e5ddd5;
    }

    #chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      word-break: break-word;
    }

    .chat-wrapper {
      display: flex;
      margin-bottom: 10px;
    }

    .chat-bubble {
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 70%;
      box-shadow: 0 1px 1px rgba(0,0,0,0.2);
      position: relative;
    }

    .chat-left {
      justify-content: flex-start;
    }

    .chat-right {
      justify-content: flex-end;
    }

    .chat-left .chat-bubble {
      background-color: white;
      color: black;
      border-bottom-left-radius: 0;
    }

    .chat-right .chat-bubble {
      background-color: #dcf8c6;
      color: black;
      border-bottom-right-radius: 0;
    }

    .chat-meta {
      font-size: 0.75rem;
      opacity: 0.6;
      margin-top: 4px;
      text-align: right;
    }

    #message-form {
      background-color: #fff;
      padding: 1rem;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <%- include("./partials/nav") %>

  <h1 class="text-center mt-3">Chatting</h1>

  <script src="/socket.io/socket.io.js"></script>

  <div class="chat-container">
    <!-- Scrollable chat area -->
    <div id="chat-area"></div>

    <!-- Fixed input at bottom -->
    <form id="message-form">
      <input
        type="text"
        id="message-input"
        class="form-control"
        placeholder="Type a message"
        autocomplete="off"
      />
    </form>
  </div>

  <script>
    const socket = io();
    const chatArea = document.getElementById("chat-area");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");

    const currentUser = "<%= user.fullName %>";

    messageForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const msg = messageInput.value.trim();
      if (!msg) return;

      socket.emit("user-message", {
        sender: currentUser,
        content: msg,
      });

      messageInput.value = "";
    });

    socket.on("message", (data) => {
      const isSelf = data.sender === currentUser;

      const wrapper = document.createElement("div");
      wrapper.className = `chat-wrapper ${isSelf ? "chat-right" : "chat-left"}`;

      const bubble = document.createElement("div");
      bubble.className = "chat-bubble";

      const name = isSelf ? "You" : data.sender;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      bubble.innerHTML = `
        <div><strong>${name}</strong></div>
        <div>${data.content}</div>
        <div class="chat-meta">${time}</div>
      `;

      wrapper.appendChild(bubble);
      chatArea.appendChild(wrapper);

      // Always scroll to bottom
      chatArea.scrollTop = chatArea.scrollHeight;
    });
  </script>

  <%- include("./partials/scripts") %>
</body>
</html>
